<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AI è‡ªæˆ‘ä¿®æ­£èˆ‡é€²åŒ–æœ¨ç´æ©Ÿ</title>
    <style>
        body { margin: 0; background: #0f172a; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; color: #f8fafc; font-family: sans-serif; }
        .panel { position: fixed; top: 0; left: 0; right: 0; background: rgba(15, 23, 42, 0.9); padding: 15px; display: flex; gap: 10px; justify-content: center; z-index: 100; border-bottom: 1px solid #334155; }
        canvas { background: #020617; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        input, button { padding: 10px; border-radius: 6px; border: 1px solid #475569; background: #1e293b; color: white; }
        button { background: #10b981; border: none; cursor: pointer; font-weight: bold; }
        .log { position: fixed; bottom: 20px; left: 20px; color: #fbbf24; font-family: monospace; font-size: 12px; max-height: 100px; overflow: hidden; }
    </style>
</head>
<body>

<div class="panel">
    <strong>ç‰©ç†é€²åŒ–æ¨¡å¼ï¼š</strong>
    <input type="text" id="customInput" value="1231 1231 345  345" size="40">
    <button onclick="applyAndPlay()">é–‹å§‹æ¼”å¥ (å…·å‚™è‡ªæˆ‘ä¿®å¾©)</button>
</div>

<div class="log" id="systemLog">ç³»çµ±æ—¥èªŒï¼šç­‰å¾…å•Ÿå‹•...</div>
<canvas id="xloCanvas"></canvas>

<script>
const canvas = document.getElementById('xloCanvas');
const ctx = canvas.getContext('2d');
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const freqMap = { '1': 261.6, '2': 293.7, '3': 329.6, '4': 349.2, '5': 392.0, '6': 440.0, '7': 493.9, '+1': 523.3 };

let steps = [];
let ball = null;
let camera = { x: 0, y: 0 };
const GRAVITY = 0.45;
const TARGET_VX = 5.2;

function log(msg) {
    const el = document.getElementById('systemLog');
    el.innerHTML = msg + "<br>" + el.innerHTML;
}

function buildTrack(notation) {
    steps = [];
    let curX = 150, curY = 200;
    let notationArray = [];
    for(let i=0; i<notation.length; i++) {
        if(notation[i]==='+') { notationArray.push('+'+notation[i+1]); i++; }
        else { notationArray.push(notation[i]); }
    }

    notationArray.forEach((n, idx) => {
        if (n === ' ') { curX += 160; curY += 85; }
        else if (freqMap[n]) {
            let spaceCount = 0;
            let j = idx + 1;
            while (j < notationArray.length && notationArray[j] === ' ') { spaceCount++; j++; }
            
            steps.push({
                x: curX, y: curY, freq: freqMap[n], label: n,
                w: 120 + (spaceCount * 150), h: 25,
                active: 0, 
                hitCount: 0, // è¨˜éŒ„æ“Šä¸­æ¬¡æ•¸
                lastHitTime: 0,
                color: `hsl(${(steps.length * 50) % 360}, 60%, 50%)`
            });
            curX += 160 * (1 + spaceCount);
            curY += 45 + (spaceCount * 70);
        }
    });
}

function update() {
    if (!ball) return;
    ball.vy += GRAVITY;
    ball.x += ball.vx;
    ball.y += ball.vy;

    steps.forEach((s, idx) => {
        if (ball.x + ball.r > s.x && ball.x - ball.r < s.x + s.w &&
            ball.y + ball.r > s.y && ball.y - ball.r < s.y + s.h && ball.vy > 0) {
            
            const now = Date.now();
            if (now - s.lastHitTime > 150) {
                s.hitCount++;
                s.lastHitTime = now;
                
                // --- è‡ªæˆ‘å¯Ÿè¦ºèˆ‡ä¿®æ­£é‚è¼¯ ---
                if (s.hitCount >= 2) {
                    log(`âš ï¸ åµæ¸¬åˆ°é‡è¤‡è·³å‹•æ–¼ [${s.label}]ï¼Œæ­£åœ¨ä¿®æ­£è»Œé“...`);
                    
                    // 1. ä¿®æ­£é•·åº¦ï¼šå¦‚æœä¸€ç›´è·³ï¼Œå°±æŠŠæ¿å­ç¸®çŸ­ï¼Œè®“çƒæ‰ä¸‹å»
                    s.w -= 40; 
                    
                    // 2. ä¿®æ­£é«˜åº¦ï¼šå¦‚æœä¸‹ä¸€å€‹éŸ³éšå­˜åœ¨ï¼Œé™ä½ä¸‹ä¸€å€‹éŸ³éšçš„é«˜åº¦ï¼Œç¢ºä¿èƒ½æ¥åˆ°
                    if (steps[idx+1]) {
                        steps[idx+1].y -= 20; 
                        log(`ğŸ”§ å·²é™ä½ä¸‹ä¸€éŸ³éš [${steps[idx+1].label}] é«˜åº¦`);
                    }

                    // 3. å¼·åˆ¶æ¨é€²ï¼šçµ¦äºˆé¡å¤–çš„æ°´å¹³è¡é‡
                    ball.vx += 1.5;
                }

                // æ­£å¸¸å½ˆè·³
                ball.y = s.y - ball.r;
                ball.vy = -4.8; 
                s.active = 20;
                playNote(s.freq);
            }
        }
    });

    // æ”å½±æ©Ÿå¹³æ»‘è·Ÿéš¨
    camera.x += (ball.x - canvas.width/3 - camera.x) * 0.1;
    camera.y += (ball.y - canvas.height/2 - camera.y) * 0.1;

    // æ‰è½éæ·±é‡ç½®
    if (steps.length > 0 && ball.y > steps[steps.length-1].y + 1000) {
        log("ğŸ”„ æ­Œæ›²çµæŸæˆ–çƒå·²æ‰è½ï¼Œé‡ç½®ä¸­...");
        applyAndPlay(); 
    }
}

function playNote(f) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'sine'; o.frequency.value = f;
    g.gain.setValueAtTime(0.4, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + 0.5);
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(-camera.x, -camera.y);

    steps.forEach(s => {
        ctx.fillStyle = s.active > 0 ? '#fff' : s.color;
        if (s.active > 0) s.active -= 2;
        ctx.beginPath();
        ctx.roundRect(s.x, s.y, s.w, s.h, 8);
        ctx.fill();
        ctx.fillStyle = "white";
        ctx.fillText(s.label, s.x + 10, s.y + 18);
    });

    if (ball) {
        ctx.fillStyle = "#ff4757";
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
        ctx.fill();
    }

    ctx.restore();
    update();
    requestAnimationFrame(draw);
}

function applyAndPlay() {
    log("ğŸš€ é‹ªè¨­æ–°è»Œé“ï¼Œç™¼å°„çƒ...");
    buildTrack(document.getElementById('customInput').value);
    ball = { x: 50, y: 150, vx: TARGET_VX, vy: 0, r: 15 };
}

applyAndPlay();
draw();
</script>
</body>
</html>
