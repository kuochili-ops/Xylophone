<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AI é€éŸ³ä¿®æ­£æœ¨ç´æ¼”å¥æ©Ÿ</title>
    <style>
        body { margin: 0; background: #0f172a; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; color: #f8fafc; font-family: sans-serif; overflow: hidden; }
        .panel { position: fixed; top: 0; left: 0; right: 0; background: rgba(15, 23, 42, 0.9); padding: 15px; display: flex; gap: 10px; justify-content: center; z-index: 100; border-bottom: 2px solid #3b82f6; }
        canvas { background: #020617; border-radius: 12px; }
        .stats { position: fixed; right: 20px; top: 80px; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 8px; border: 1px solid #444; font-family: monospace; }
        .log { position: fixed; bottom: 20px; left: 20px; color: #fbbf24; font-size: 13px; max-height: 150px; overflow-y: auto; width: 300px; }
        .highlight { color: #10b981; font-weight: bold; }
    </style>
</head>
<body>

<div class="panel">
    <strong>AI è¨“ç·´æ¨¡å¼ï¼š</strong>
    <input type="text" id="customInput" value="1231 1231 345  345" size="40" style="padding:8px; border-radius:4px; background:#1e293b; color:white; border:1px solid #444;">
    <button onclick="applyAndPlay()" style="background:#3b82f6; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">é–‹å§‹è¨“ç·´</button>
</div>

<div class="stats" id="statsBox">
    <div>å˜—è©¦æ¬¡æ•¸: <span id="attemptCount">1</span></div>
    <div>ç›®å‰é€²åº¦: <span id="currentProgress">0</span> / <span id="totalNotes">0</span></div>
    <div>ä¿®æ­£ç‹€æ…‹: <span id="fixStatus">åµæ¸¬ä¸­</span></div>
</div>

<div class="log" id="systemLog">ç³»çµ±ï¼šç­‰å¾…æŒ‡ä»¤...</div>
<canvas id="xloCanvas"></canvas>

<script>
const canvas = document.getElementById('xloCanvas');
const ctx = canvas.getContext('2d');
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const freqMap = { '1': 261.6, '2': 293.7, '3': 329.6, '4': 349.2, '5': 392.0, '6': 440.0, '7': 493.9, '+1': 523.3 };

let steps = [];
let ball = null;
let camera = { x: 0, y: 0 };
let currentNoteIndex = 0;
let attempts = 1;
const GRAVITY = 0.45;
const VX = 5;

function log(msg) {
    const el = document.getElementById('systemLog');
    el.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + el.innerHTML;
}

function buildTrack(notation) {
    steps = [];
    let curX = 200, curY = 200;
    let notationArray = [];
    for(let i=0; i<notation.length; i++) {
        if(notation[i]==='+') { notationArray.push('+'+notation[i+1]); i++; }
        else { notationArray.push(notation[i]); }
    }

    notationArray.forEach((n, idx) => {
        if (n === ' ') { curX += 160; curY += 80; }
        else if (freqMap[n]) {
            steps.push({
                x: curX, y: curY, freq: freqMap[n], label: n,
                w: 120, h: 25, active: 0,
                color: `hsl(${(steps.length * 40) % 360}, 60%, 50%)`
            });
            curX += 160; curY += 45;
        }
    });
    document.getElementById('totalNotes').innerText = steps.length;
}

function playNote(f) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'sine'; o.frequency.value = f;
    g.gain.setValueAtTime(0.4, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + 0.4);
}

function applyAndPlay() {
    buildTrack(document.getElementById('customInput').value);
    resetBall();
}

function resetBall() {
    ball = { x: 50, y: 150, vx: VX, vy: 0, r: 15 };
    currentNoteIndex = 0;
    camera = { x: 0, y: 0 };
}

function failAndFix(reason) {
    log(`<span style="color:#ef4444">âŒ å¤±æ•—ï¼š${reason}</span>`);
    document.getElementById('fixStatus').innerText = "ä¿®æ­£è»Œé“ä¸­...";
    
    // ä¿®æ­£é‚è¼¯ï¼šé‡å°ç•¶å‰ç›®æ¨™éŸ³ç¬¦ï¼ˆæˆ–å‰ä¸€å€‹éŸ³ç¬¦ï¼‰é€²è¡Œç‰©ç†èª¿æ•´
    if (steps[currentNoteIndex]) {
        const target = steps[currentNoteIndex];
        if (reason === "éŒ¯ééŸ³ç¬¦") {
            // å¦‚æœçƒæ‰å¤ªæ·±æ¥ä¸åˆ°ï¼Œå°±æŠŠç›®æ¨™éŸ³ç¬¦å¾€çƒçš„æ–¹å‘é æ”ï¼ˆä¿®æ­£è½å·®ï¼‰
            target.y -= 30;
            target.x -= 20;
            log(`ğŸ”§ ä¿®æ­£éŸ³ç¬¦ [${target.label}]ï¼šæé«˜ä½ç½®ä¸¦ç¸®çŸ­è·é›¢`);
        } else if (reason === "å¡åœ¨éŸ³éš") {
            // å¦‚æœé‡è¤‡è·³å‹•ï¼Œç¸®çŸ­æ¿å­å¯¬åº¦
            target.w -= 30;
            log(`ğŸ”§ ä¿®æ­£éŸ³ç¬¦ [${target.label}]ï¼šç¸®çŸ­æ¿å­å¯¬åº¦é˜²æ­¢å—å›°`);
        }
    }

    attempts++;
    document.getElementById('attemptCount').innerText = attempts;
    setTimeout(resetBall, 500); // ç¨å¾®åœé “å¾Œé‡é ­å†ä¾†
}

function update() {
    if (!ball) return;
    ball.vy += GRAVITY;
    ball.x += ball.vx;
    ball.y += ball.vy;

    steps.forEach((s, idx) => {
        if (ball.x + ball.r > s.x && ball.x - ball.r < s.x + s.w &&
            ball.y + ball.r > s.y && ball.y - ball.r < s.y + s.h && ball.vy > 0) {
            
            // å¦‚æœæ’æ“Šçš„ä¸æ˜¯ã€Œä¸‹ä¸€å€‹æ‡‰è©²æ’æ“Šçš„éŸ³ç¬¦ã€ï¼Œä¹Ÿç®—å¤±æ•—
            if (idx !== currentNoteIndex && idx < currentNoteIndex) {
                 // é‡è¤‡æ’åˆ°èˆŠéŸ³ç¬¦ï¼Œä¿®æ­£
                 failAndFix("å¡åœ¨éŸ³éš");
                 return;
            }

            ball.y = s.y - ball.r;
            ball.vy = -5; // å›ºå®šæ¨åŠ›
            s.active = 15;
            playNote(s.freq);
            
            if (idx === currentNoteIndex) {
                currentNoteIndex++;
                document.getElementById('currentProgress').innerText = currentNoteIndex;
                document.getElementById('fixStatus').innerText = "æ­£å¸¸æ¼”å¥ä¸­";
            }
        }
    });

    // åˆ¤å®šéŒ¯ééŸ³ç¬¦ï¼šå¦‚æœçƒçš„ X åº§æ¨™å·²ç¶“è¶…éäº†ç›®æ¨™éŸ³ç¬¦çš„ Xï¼Œä¸” Y å·²ç¶“æ‰ä¸‹å»
    if (steps[currentNoteIndex]) {
        const target = steps[currentNoteIndex];
        if (ball.x > target.x + target.w + 50 || ball.y > target.y + 200) {
            failAndFix("éŒ¯ééŸ³ç¬¦");
        }
    } else if (currentNoteIndex >= steps.length) {
        log("<span class='highlight'>âœ… æˆåŠŸï¼å…¨æ›²æ¼”å¥å®Œç•¢ä¸”ç„¡ä¿®æ­£éœ€æ±‚ã€‚</span>");
        ball = null;
    }

    camera.x += (ball.x - canvas.width/3 - camera.x) * 0.1;
    camera.y += (ball.y - canvas.height/2 - camera.y) * 0.1;
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(-camera.x, -camera.y);

    steps.forEach((s, i) => {
        // ç•«å‡ºç›®å‰çš„ç›®æ¨™éŸ³ç¬¦æç¤º
        if (i === currentNoteIndex) {
            ctx.strokeStyle = "#fbbf24";
            ctx.lineWidth = 3;
            ctx.strokeRect(s.x - 5, s.y - 5, s.w + 10, s.h + 10);
        }

        ctx.fillStyle = s.active > 0 ? '#fff' : s.color;
        if (s.active > 0) s.active--;
        ctx.beginPath();
        ctx.roundRect(s.x, s.y, s.w, s.h, 6);
        ctx.fill();
        ctx.fillStyle = "white";
        ctx.font = "bold 14px monospace";
        ctx.fillText(s.label, s.x + 10, s.y + 16);
    });

    if (ball) {
        ctx.fillStyle = "#ff4757";
        ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); ctx.fill();
    }

    ctx.restore();
    update();
    requestAnimationFrame(draw);
}

applyAndPlay();
draw();
</script>
</body>
</html>
