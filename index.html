<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>木琴滾球 - 視角鎖定版</title>
    <style>
        body { margin: 0; background: #1a1a1a; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; color: #ecf0f1; font-family: sans-serif; }
        .controls { position: fixed; top: 20px; display: flex; gap: 10px; z-index: 10; background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px; }
        canvas { background: #242424; cursor: pointer; border: 2px solid #444; }
        button { padding: 8px 15px; cursor: pointer; background: #e67e22; border: none; color: white; border-radius: 4px; }
    </style>
</head>
<body>

<div class="controls">
    <select id="songSelect">
        <option value="star">小星星 (長版)</option>
        <option value="bee">小蜜蜂 (節奏版)</option>
    </select>
    <button onclick="spawnBall()">開始演奏</button>
</div>

<canvas id="xloCanvas"></canvas>

<script>
const canvas = document.getElementById('xloCanvas');
const ctx = canvas.getContext('2d');
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

// 設定畫布大小為全螢幕
canvas.width = window.innerWidth * 0.9;
canvas.height = window.innerHeight * 0.7;

const FREQ = {
    'C4': 261.6, 'D4': 293.7, 'E4': 329.6, 'F4': 349.2, 'G4': 392.0, 'A4': 440.0, 'B4': 493.9,
    'C5': 523.3, 'D5': 587.3, 'E5': 659.3, 'G5': 784.0
};

const SONGS = {
    star: ['C4','C4','G4','G4','A4','A4','G4','F4','F4','E4','E4','D4','D4','C4','G4','G4','F4','F4','E4','E4','D4','G4','G4','F4','F4','E4','E4','D4','C4','C4','G4','G4','A4','A4','G4'],
    bee: ['G4','E4','E4','F4','D4','D4','C4','D4','E4','F4','G4','G4','G4','G4','E4','E4','F4','D4','D4','C4','E4','G4','G4','C4']
};

let steps = [];
let ball = null;
let camera = { x: 0, y: 0 };
const gravity = 0.35;

function initSong(id) {
    steps = [];
    ball = null;
    const melody = SONGS[id];
    melody.forEach((note, i) => {
        steps.push({
            x: 100 + i * 150,      // 增加橫向距離，給予滾動空間
            y: 150 + i * 40,       // 階梯穩定下降，防止球突然消失
            note: note,
            freq: FREQ[note],
            w: 100,
            h: 20,
            active: 0
        });
    });
}

function playSound(freq) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.5);
}

function spawnBall() {
    ball = { x: 50, y: 50, vx: 4, vy: 0, r: 15 };
    camera.x = 0;
    camera.y = 0;
}

function update() {
    if (!ball) return;

    ball.vy += gravity;
    ball.x += ball.vx;
    ball.y += ball.vy;

    // 碰撞與演奏邏輯
    steps.forEach(step => {
        if (ball.x + ball.r > step.x && ball.x - ball.r < step.x + step.w &&
            ball.y + ball.r > step.y && ball.y - ball.r < step.y + step.h &&
            ball.vy > 0) {
            
            ball.y = step.y - ball.r;
            ball.vy *= -0.55; // 反彈力優化，防止跳太高
            ball.vx = 4;      // 保持前進速度
            
            if (step.active <= 0) {
                playSound(step.freq);
                step.active = 20;
            }
        }
    });

    // 攝影機跟隨核心：平滑追蹤球的心臟
    // 讓球保持在畫面左方 1/3 的位置
    let targetCamX = ball.x - canvas.width / 3;
    let targetCamY = ball.y - canvas.height / 2;
    
    camera.x += (targetCamX - camera.x) * 0.1;
    camera.y += (targetCamY - camera.y) * 0.1;

    // 如果球掉太深（歌曲結束），重設
    if (ball.y > steps[steps.length-1].y + 500) {
        spawnBall(); 
    }
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.save();
    ctx.translate(-camera.x, -camera.y); // 全方位視角位移

    // 繪製木琴
    steps.forEach((step, i) => {
        // 木琴顏色隨音高變化
        let hue = 200 + (i * 10) % 100; 
        ctx.fillStyle = step.active > 0 ? '#fff' : `hsl(${hue}, 50%, 45%)`;
        if (step.active > 0) step.active -= 2;

        ctx.beginPath();
        ctx.roundRect(step.x, step.y, step.w, step.h, 8);
        ctx.fill();

        // 裝飾線條（讓它看起來像木琴）
        ctx.strokeStyle = "rgba(255,255,255,0.2)";
        ctx.strokeRect(step.x + 5, step.y + 2, step.w - 10, step.h - 4);
    });

    // 繪製木球
    if (ball) {
        ctx.fillStyle = '#ff7675';
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#ff7675';
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;
    }

    ctx.restore();

    update();
    requestAnimationFrame(draw);
}

document.getElementById('songSelect').addEventListener('change', (e) => initSong(e.target.value));
initSong('star');
draw();
</script>

</body>
</html>
