<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ğ“ƒ¥ç™½å…­æœ¨ç´å·¥åŠ - å¼·åˆ¶å•Ÿå‹•ç‰ˆ</title>
    <script src="https://unpkg.com/@tonejs/midi"></script>
    <style>
        :root { --accent: #3b82f6; --success: #10b981; }
        body { margin: 0; background: #010409; color: #fff; font-family: -apple-system, sans-serif; overflow: hidden; touch-action: none; }
        #setupPanel { position: fixed; inset: 0; background: #020617; z-index: 9999; padding: 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        .config-card { background: rgba(15, 23, 42, 0.98); padding: 25px; border-radius: 24px; border: 1px solid #334155; width: 90%; max-width: 420px; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-size: 14px; color: #94a3b8; font-weight: bold; }
        select, input[type="file"], input[type="text"] { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #334155; background: #0f172a; color: #fff; font-size: 14px; box-sizing: border-box; }
        
        /* æ‡¸æµ®æ’­æ”¾æŒ‰éˆ• */
        #playOverlay { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10001; display: none; }
        .big-start-btn { padding: 15px 40px; border-radius: 50px; background: var(--success); color: white; border: none; font-size: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px rgba(16, 185, 129, 0.5); }
        
        #uiPanel { position: fixed; bottom: 30px; right: 20px; z-index: 10000; display: none; }
        .toggle-btn { width: 56px; height: 56px; border-radius: 50%; background: #1e293b; border: 2px solid #475569; color: white; font-size: 24px; cursor: pointer; }
        
        #stage { display: block; width: 100vw; height: 100vh; }
    </style>
</head>
<body>

<div id="setupPanel">
    <div class="config-card">
        <h2 style="text-align:center; color:var(--accent);">ğŸ¹ ä¿®æ­£ï¼šé»æ“Šå³æ»¾å‹•</h2>
        <div class="input-group">
            <label>1. é¸æ“‡æ›²ç›®</label>
            <select id="midiSelect" onchange="changeDefaultMidi(this.value)">
                <option value="b3501.mid">b3501.mid</option>
                <option value="kaze.mid">kaze.mid</option>
                <option value="Mario Bros. - Super Mario Bros. Theme.mid">Super Mario Bros.</option>
            </select>
        </div>
        <div class="input-group">
            <label>æˆ–è€…ï¼šè‡ªè¡Œä¸Šå‚³</label>
            <input type="file" id="midiFile" accept=".mid,.midi" onchange="handleManualUpload(this)">
            <div id="midiStatus" style="font-size:12px; color:var(--success); margin-top:5px;">é è¨­ï¼šb3501.mid</div>
        </div>
        <div class="input-group">
            <label>2. çµæŸè¨Šæ¯</label>
            <input type="text" id="msgInit" value="æ¼”å‡ºçµæŸï¼Œè¬è¬è§€è³">
        </div>
        <button style="width:100%; padding:16px; border-radius:14px; background:var(--accent); color:white; border:none; font-weight:bold; cursor:pointer;" onclick="enterScene()">é€²å…¥å ´æ™¯</button>
    </div>
</div>

<div id="playOverlay">
    <button class="big-start-btn" onclick="startApp()">â–¶ é»æˆ‘é–‹å§‹æ»¾å‹•</button>
</div>

<div id="uiPanel">
    <button class="toggle-btn" onclick="location.reload()">ğŸ”„</button>
</div>

<canvas id="stage"></canvas>

<script>
const canvas = document.getElementById('stage');
const ctx = canvas.getContext('2d', { alpha: false });
let audioCtx, tracks = [], isRunning = false, isBallMoving = false, isPaused = false, stars = [];
let camX = 0, camY = 0, midiData = null, currentMsg = "";

const GRAVITY = 3200, BALL_VX = 420, BOUNCE_UP = -24, BALL_R = 12;

async function loadServerMidi(filename) {
    const response = await fetch(filename);
    const buf = await response.arrayBuffer();
    midiData = new Midi(buf);
    document.getElementById('midiStatus').innerText = `âœ… å·²è®€å–: ${filename}`;
}
loadServerMidi('b3501.mid');

function changeDefaultMidi(val) { loadServerMidi(val); }
function handleManualUpload(input) {
    if(input.files[0]) {
        input.files[0].arrayBuffer().then(buf => {
            midiData = new Midi(buf);
            document.getElementById('midiStatus').innerText = "âœ… å·²ä¸Šå‚³ï¼š" + input.files[0].name;
        });
    }
}

async function enterScene() {
    if(!midiData) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    currentMsg = document.getElementById('msgInit').value;
    
    tracks = [];
    const sorted = [...midiData.tracks].sort((a,b) => b.notes.length - a.notes.length).slice(0, 3);
    
    sorted.forEach((track, idx) => {
        const steps = [];
        const baseOffset = idx * 250;
        let notes = track.notes.sort((a,b) => a.time - b.time);

        // ç·©è¡èµ·å§‹å°
        steps.push({ x: 0, y: (canvas.height*0.3 + baseOffset), w: 400, isNote: false, active: 0, color: '#1e293b' });

        notes.forEach((n, i) => {
            let x = n.time * BALL_VX + 400;
            let y = (canvas.height*0.3 + baseOffset) + (i % 2 === 0 ? 0 : 20);
            let w = Math.max(n.duration * BALL_VX, 80);
            
            let prev = steps[steps.length-1];
            if (x > prev.x + prev.w) { prev.w = (x - prev.x) + 10; }

            steps.push({ x, y, w, freq: 440 * Math.pow(2, (n.midi-69)/12), isNote: true, active: 0, color: `hsla(${(n.midi%12)*30}, 70%, 60%, 0.8)` });
        });

        tracks.push({ 
            steps, 
            ball: { x: 50, y: steps[0].y - 50, vx: BALL_VX, vy: 0, color: ['#ff4757','#54a0ff','#2ed573'][idx], tails: [] }, 
            cur: 0 
        });
    });

    document.getElementById('setupPanel').style.display = 'none';
    document.getElementById('playOverlay').style.display = 'block';
    isRunning = true;
    initStars();
    requestAnimationFrame(loop);
}

function startApp() {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    isBallMoving = true;
    document.getElementById('playOverlay').style.display = 'none';
    document.getElementById('uiPanel').style.display = 'block';
}

function loop() {
    if (!isRunning) return;
    const dt = 1/60;
    
    if (isBallMoving) {
        tracks.forEach(t => {
            const b = t.ball;
            b.vy += GRAVITY * dt;
            b.x += b.vx * dt;
            b.y += b.vy * dt;
            
            let onGround = false;
            for (let i = t.cur; i < Math.min(t.cur + 20, t.steps.length); i++) {
                let s = t.steps[i];
                if (b.x >= s.x && b.x <= s.x + s.w && b.y + BALL_R >= s.y && b.y < s.y + 20) {
                    b.y = s.y - BALL_R;
                    b.vy = BOUNCE_UP;
                    t.cur = i;
                    if(!s.active && s.isNote) playSound(s);
                    onGround = true; break;
                }
            }
            b.tails.push({x: b.x, y: b.y}); if(b.tails.length > 10) b.tails.shift();
        });

        camX += (tracks[0].ball.x - canvas.width * 0.2 - camX) * 0.1;
        camY += (tracks[0].ball.y - canvas.height * 0.5 - camY) * 0.05;
    }
    draw();
    requestAnimationFrame(loop);
}

function playSound(s) {
    s.active = 1;
    const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
    osc.type = 'triangle'; osc.frequency.value = s.freq;
    g.gain.setValueAtTime(0.1, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
    osc.connect(g); g.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + 0.3);
}

function initStars() { stars = Array.from({length:80}, () => ({x: Math.random()*canvas.width, y: Math.random()*canvas.height})); }

function draw() {
    ctx.fillStyle = "#010409"; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.save(); ctx.translate(-camX, -camY);
    tracks.forEach(t => {
        t.steps.forEach(s => {
            ctx.fillStyle = s.active ? "#fff" : s.color;
            ctx.beginPath(); ctx.roundRect(s.x, s.y, s.w, 15, 8); ctx.fill();
        });
        ctx.fillStyle = t.ball.color;
        ctx.beginPath(); ctx.arc(t.ball.x, t.ball.y, BALL_R, 0, Math.PI*2); ctx.fill();
    });
    ctx.restore();
    if (!isBallMoving && isRunning) {
        ctx.fillStyle = "rgba(255,255,255,0.5)"; ctx.textAlign="center"; ctx.fillText("ç­‰å¾…å•Ÿå‹•...", canvas.width/2, canvas.height/2 + 100);
    }
}
canvas.width = window.innerWidth; canvas.height = window.innerHeight;
</script>
</body>
</html>
