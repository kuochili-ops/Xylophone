<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AI æœ¨ç´æ©Ÿ - æ—‹è½‰å•Ÿå‹•æ¨¡çµ„</title>
    <style>
        body { margin: 0; background: #0f172a; color: #f8fafc; font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        .panel { position: fixed; top: 0; width: 100%; background: rgba(15, 23, 42, 0.9); padding: 15px; display: flex; gap: 10px; justify-content: center; z-index: 10; border-bottom: 2px solid #3b82f6; }
        canvas { background: #020617; border-radius: 12px; }
        .stats { position: fixed; top: 80px; right: 20px; background: rgba(30, 41, 59, 0.8); padding: 15px; border-radius: 8px; border: 1px solid #475569; font-family: monospace; }
        .ai-log { position: fixed; bottom: 20px; left: 20px; width: 350px; max-height: 180px; overflow-y: auto; background: rgba(15, 23, 42, 0.95); padding: 12px; border-radius: 6px; color: #fbbf24; font-size: 12px; border-left: 4px solid #10b981; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button:active { background: #2563eb; }
    </style>
</head>
<body>

<div class="panel">
    <strong>å•Ÿå‹•é‚è¼¯ï¼š</strong>
    <input type="text" id="notation" value="1231 1231 345  345" size="35" style="padding:8px; background:#1e293b; color:white; border:1px solid #475569;">
    <button id="startBtn" onclick="triggerStart()">å•Ÿå‹•æ—‹è½‰</button>
</div>

<div class="stats">
    <div>å˜—è©¦æ¬¡æ•¸: <span id="att">1</span></div>
    <div>0è™Ÿæ¿æ—‹è½‰: <span id="rot">0</span>Â°</div>
</div>

<div class="ai-log" id="log">ç³»çµ±ï¼šçƒå·²å°±ä½ï¼Œç­‰å¾…æ—‹è½‰...</div>
<canvas id="mainCanvas"></canvas>

<script>
const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d');
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const freqMap = { '1': 261.6, '2': 293.7, '3': 329.6, '4': 349.2, '5': 392.0, '6': 440.0, '7': 493.9, '+1': 523.3 };

let steps = [];
let ball = null;
let camera = { x: 0, y: 0 };
let currentIdx = 0;
let attempts = 1;
let isStarted = false;
let startPlateRotation = 0; // 0è™Ÿæ¿æ—‹è½‰å¼§åº¦

function addLog(msg) {
    const l = document.getElementById('log');
    l.innerHTML = `<div>[${attempts}] ${msg}</div>` + l.innerHTML;
}

function buildTrack(str) {
    steps = [];
    // å»ºç«‹ 0 è™Ÿå•Ÿå‹•æ¿ (ä¸ç™¼è²)
    steps.push({ x: 100, y: 200, w: 150, h: 20, isStartPlate: true, label: "START", color: "#64748b", active: 0, hitCount: 0 });

    let curX = 350, curY = 320;
    let notes = [];
    for(let i=0; i<str.length; i++) {
        if(str[i]==='+') { notes.push('+'+str[i+1]); i++; }
        else { notes.push(str[i]); }
    }
    notes.forEach((n) => {
        if (n === ' ') { curX += 160; curY += 80; }
        else if (freqMap[n]) {
            steps.push({ x: curX, y: curY, freq: freqMap[n], label: n, w: 120, h: 25, active: 0, hitCount: 0, color: `hsl(${(steps.length * 50) % 360}, 60%, 50%)` });
            curX += 160; curY += 45;
        }
    });
}

function play(f) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'sine'; o.frequency.value = f;
    g.gain.setValueAtTime(0.4, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + 0.4);
}

function triggerStart() {
    isStarted = true;
    document.getElementById('startBtn').disabled = true;
}

function resetBall() {
    const startPlate = steps[0];
    // çƒå›åˆ° 0 è™Ÿæ¿ä¸­é–“
    ball = { x: startPlate.x + startPlate.w / 2, y: startPlate.y - 16, vx: 0, vy: 0, r: 15, onPlate: true };
    currentIdx = 0; // å¾ 0 è™Ÿæ¿é–‹å§‹æª¢æŸ¥
    startPlateRotation = 0;
    isStarted = false;
    document.getElementById('startBtn').disabled = false;
    steps.forEach(s => s.hitCount = 0);
}

function fail(reason, targetIdx) {
    addLog(`<span style="color:#f87171">å¤±æ•—ï¼š${reason}</span>`);
    const target = steps[targetIdx];
    
    if (target) {
        if (targetIdx === 1 && reason === "æ²’æ¥åˆ°éŸ³ç¬¦") {
            // å¦‚æœ 1 è™ŸéŸ³æ²’æ¥åˆ°ï¼Œä¿®æ­£ 1 è™Ÿæ¿ä½ç½®
            target.x -= 30; target.y -= 20;
            addLog(`ğŸ”§ <b>ä¿®æ­£ 1 è™ŸéŸ³æ¿ä½ç§»ä»¥æ¥çƒ</b>`);
        } else if (reason === "é‡è¤‡å½ˆè·³") {
            target.w -= 40; target.x -= 20;
            addLog(`ğŸ”§ <b>éŸ³ç¬¦ [${target.label}] é‡è¤‡ï¼šç¸®çŸ­æ¿é•·ä¸¦å·¦ç§»</b>`);
        } else if (reason === "æ²’æ¥åˆ°éŸ³ç¬¦") {
            target.y += 35; target.x -= 30;
            addLog(`ğŸ”§ <b>éŸ³ç¬¦ [${target.label}] æ¥ä¸åˆ°ï¼šå¢åŠ è½å·®</b>`);
        }
    }

    attempts++;
    document.getElementById('att').innerText = attempts;
    setTimeout(resetBall, 400);
}

function update() {
    if (!ball) return;

    if (isStarted && ball.onPlate) {
        // 0 è™Ÿæ¿åš Z è»¸(é †æ™‚é‡)æ—‹è½‰
        startPlateRotation += 0.015; 
        document.getElementById('rot').innerText = (startPlateRotation * 180 / Math.PI).toFixed(1);
        
        // ç‰©ç†æ¨¡æ“¬ï¼šçƒéš¨æ—‹è½‰ç”¢ç”Ÿå‘å³åŠ é€Ÿåº¦
        ball.vx += Math.sin(startPlateRotation) * 0.5;
        ball.x += ball.vx;
        ball.y = steps[0].y - ball.r + (ball.x - (steps[0].x + steps[0].w/2)) * Math.tan(startPlateRotation);

        // å¦‚æœçƒæ»¾å‡º 0 è™Ÿæ¿é‚Šç·£ï¼Œè„«é›¢å¹³æ¿é€²å…¥è‡ªç”±è½é«”
        if (ball.x > steps[0].x + steps[0].w) {
            ball.onPlate = false;
            currentIdx = 1; // è„«é›¢å¾Œç›®æ¨™è®Šæˆ 1 è™Ÿæ¿
            addLog("çƒå·²è½ä¸‹ï¼Œé–‹å§‹æ¼”å¥...");
        }
    } else if (!ball.onPlate) {
        ball.vy += 0.48; // Gravity
        ball.x += ball.vx;
        ball.y += ball.vy;
    }

    // ç¢°æ’æª¢æ¸¬ (è·³é 0 è™Ÿæ¿)
    steps.forEach((s, i) => {
        if (i === 0) return; 
        if (ball.x + ball.r > s.x && ball.x - ball.r < s.x + s.w &&
            ball.y + ball.r > s.y && ball.y - ball.r < s.y + s.h && ball.vy > 0) {
            
            s.hitCount++;
            if (i === currentIdx && s.hitCount >= 2) { fail("é‡è¤‡å½ˆè·³", i); return; }

            if (i === currentIdx) {
                ball.y = s.y - ball.r;
                ball.vy = -4.8; 
                s.active = 15;
                play(s.freq);
                currentIdx++;
            } else if (i < currentIdx) {
                fail("é‡è¤‡å½ˆè·³", i);
            }
        }
    });

    if (!ball.onPlate && steps[currentIdx]) {
        const target = steps[currentIdx];
        if (ball.x > target.x + target.w + 50 || ball.y > target.y + 300) fail("æ²’æ¥åˆ°éŸ³ç¬¦", currentIdx);
    } else if (currentIdx >= steps.length && steps.length > 1) {
        addLog("<b style='color:#10b981'>âœ… å…¨æ›²æ¼”åŒ–æ¼”å¥å®Œæˆï¼</b>");
        ball = null;
    }

    camera.x += (ball.x - canvas.width/3 - camera.x) * 0.1;
    camera.y += (ball.y - canvas.height/2 - camera.y) * 0.1;
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(-camera.x, -camera.y);

    steps.forEach((s, i) => {
        ctx.save();
        if (i === 0) {
            // 0 è™Ÿæ¿ç‰¹æ®Šæ—‹è½‰ç¹ªè£½
            ctx.translate(s.x + s.w/2, s.y);
            ctx.rotate(startPlateRotation);
            ctx.fillStyle = s.color;
            ctx.fillRect(-s.w/2, 0, s.w, s.h);
            ctx.fillStyle = "white";
            ctx.fillText(s.label, -20, 15);
        } else {
            ctx.fillStyle = s.active > 0 ? '#fff' : s.color;
            if (s.active > 0) s.active--;
            if (i === currentIdx) {
                ctx.shadowBlur = 15; ctx.shadowColor = "#fbbf24";
                ctx.strokeStyle = "#fbbf24"; ctx.lineWidth = 2;
                ctx.strokeRect(s.x-2, s.y-2, s.w+4, s.h+4);
            }
            ctx.beginPath(); ctx.roundRect(s.x, s.y, s.w, s.h, 6); ctx.fill();
            ctx.shadowBlur = 0;
            ctx.fillStyle = "#fff"; ctx.font = "bold 14px monospace";
            ctx.fillText(s.label, s.x+10, s.y+18);
        }
        ctx.restore();
    });

    if (ball) {
        ctx.fillStyle = "#ef4444";
        ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); ctx.fill();
    }

    ctx.restore();
    update();
    requestAnimationFrame(draw);
}

buildTrack(document.getElementById('notation').value);
resetBall();
draw();
</script>
</body>
</html>
