<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>名侦探柯南 - 主旋律提取播放器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/abcjs/6.2.2/abcjs-basic-min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 30px; background: #1a1a1a; color: #eee; }
        .container { max-width: 900px; margin: auto; background: #2d2d2d; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .controls { display: flex; gap: 15px; margin: 20px 0; padding: 15px; background: #3d3d3d; border-radius: 8px; }
        button { padding: 12px 24px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.3s; }
        .btn-main { background: #e41e26; color: white; }
        .btn-melody { background: #2196F3; color: white; }
        #paper { background: white; margin-top: 20px; border-radius: 8px; overflow: hidden; }
        .info-panel { border-left: 4px solid #e41e26; padding-left: 15px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="info-panel">
        <h2>名侦探柯南主题曲：主旋律识别</h2>
        [span_1](start_span)<p>乐谱特征：F 小调[span_1](end_span)[span_2](start_span)[span_3](start_span)，主旋律由高音谱号（V:1）承载[span_2](end_span)[span_3](end_span)。</p>
    </div>
    
    <div class="controls">
        <button class="btn-main" onclick="playFull()">播放全曲 (Piano Duo)</button>
        <button class="btn-melody" onclick="playMelodyOnly()">只听主旋律 (Solo Track)</button>
    </div>

    <div id="audio-control"></div>
    <div id="paper"></div>
</div>

<script>
[span_4](start_span)// 核心 ABC 代码：区分 V:1 (旋律) 和 V:2 (伴奏)[span_4](end_span)
const fullScore = `
X:1
T:名侦探柯南主题曲 (Snippet)
M:4/4
L:1/8
Q:1/4=132
K:Ab
V:1 name="Main Melody"
%%MIDI program 65
| z4 F G | (AG) F G A F c A | (F G) (A G) (F E) D C | B, C D E F4 |
| c2 c2 B2 A2 | G2 G2 F2 G2 | A2 F4 A2 | B2 G4 B2 |
V:2 name="Bass Accomp"
%%MIDI program 0
| F,,2 F,2 C,2 F,2 | E,,2 E,2 B,,2 E,2 | D,,2 D,2 A,,2 D,2 | C,,2 C,2 G,,2 C,2 |
| F,,2 F,2 C,2 F,2 | E,,2 E,2 B,,2 E,2 | D,,2 D,2 A,,2 D,2 | C,,2 C,2 G,,2 C,2 |
`;

let visualObj;
const synthControl = new ABCJS.synth.SynthController();

function initPlayer(abcString) {
    visualObj = ABCJS.renderAbc("paper", abcString, { responsive: "resize" })[0];
    if (ABCJS.synth.supportsAudio()) {
        synthControl.load("#audio-control", null, { displayPlay: true, displayProgress: true });
        const midi = new ABCJS.synth.CreateSynth();
        midi.init({ visualObj: visualObj }).then(() => {
            synthControl.setTune(visualObj, false);
        });
    }
}

function playFull() {
    initPlayer(fullScore);
}

function playMelodyOnly() {
    // 逻辑：通过正则过滤掉 V:2 及其后的所有伴奏内容，从而提取主旋律
    const melodyOnly = fullScore.split('V:2')[0];
    initPlayer(melodyOnly);
}

// 默认加载全曲
window.onload = playFull;
</script>

</body>
</html>
