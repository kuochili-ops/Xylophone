<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AI æœ¨ç´æ©Ÿ - ç©©å®šä¿®å¾©ç‰ˆ</title>
    <style>
        body { margin: 0; background: #0f172a; color: #f8fafc; font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        .panel { background: rgba(15, 23, 42, 0.95); padding: 15px; display: flex; gap: 10px; justify-content: center; align-items: center; z-index: 10; border-bottom: 2px solid #3b82f6; flex-wrap: wrap; }
        canvas { background: #020617; flex-grow: 1; }
        .stats { position: fixed; top: 100px; right: 20px; background: rgba(30, 41, 59, 0.9); padding: 15px; border-radius: 8px; border: 1px solid #475569; font-family: monospace; min-width: 180px; z-index: 5; }
        .ai-log { position: fixed; bottom: 20px; left: 20px; width: 320px; max-height: 150px; overflow-y: auto; background: rgba(15, 23, 42, 0.95); padding: 12px; border-radius: 6px; color: #fbbf24; font-size: 12px; border-left: 4px solid #3b82f6; }
        
        button { border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-train { background: #3b82f6; color: white; }
        .btn-replay { background: #10b981; color: white; display: none; }
        .btn-clear { background: #ef4444; color: white; }
        
        select, input { padding: 8px; background: #1e293b; color: white; border: 1px solid #475569; border-radius: 4px; }
        .highlight { color: #10b981; font-weight: bold; }
    </style>
</head>
<body>

<div class="panel">
    <strong>æ›²ç›®ï¼š</strong>
    <select id="songSelect" onchange="syncNotation()">
        <option value="1155665 4433221">å°æ˜Ÿæ˜Ÿ</option>
        <option value="1231 1231 345  345">å…©éš»è€è™</option>
        <option value="334554321123322">æ­¡æ¨‚é Œ</option>
        <option value="custom">è‡ªå®šç¾©...</option>
    </select>
    <input type="text" id="notation" value="1155665 4433221" size="25">
    
    <button class="btn-train" onclick="initAudioAndStart(false)">è¨“ç·´/æ¼”å¥</button>
    <button id="replayBtn" class="btn-replay" onclick="initAudioAndStart(true)">é‡æ’­å®Œç¾ç‰ˆ</button>
    <button class="btn-clear" onclick="clearCurrentMemory()">æ¸…é™¤è¨˜æ†¶</button>
</div>

<div class="stats">
    <div>æ¨¡å¼: <span id="modeState" style="color:#fbbf24">ç­‰å¾…å•Ÿå‹•</span></div>
    <div>å˜—è©¦: <span id="att">1</span> æ¬¡</div>
    <div>å­˜æª”: <span id="saveState">æª¢æŸ¥ä¸­...</span></div>
</div>

<div class="ai-log" id="log">ç³»çµ±ï¼šè«‹é»æ“ŠæŒ‰éˆ•é–‹å§‹ã€‚</div>
<canvas id="mainCanvas"></canvas>

<script>
const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d');
let audioCtx = null;

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const freqMap = { '1': 261.6, '2': 293.7, '3': 329.6, '4': 349.2, '5': 392.0, '6': 440.0, '7': 493.9, '+1': 523.3 };

let steps = [];
let ball = null;
let camera = { x: 0, y: 0 };
let currentIdx = 0;
let attempts = 1;
let isStarted = false;
let startPlateRotation = 0;
let isReplayMode = false;

function addLog(msg) {
    const l = document.getElementById('log');
    l.innerHTML = `<div>[${new Date().toLocaleTimeString().split(' ')[0]}] ${msg}</div>` + l.innerHTML;
}

// åŒæ­¥è¼¸å…¥æ¡†å…§å®¹ä¸¦æª¢æŸ¥å­˜æª”
function syncNotation() {
    const sel = document.getElementById('songSelect');
    if(sel.value !== "custom") {
        document.getElementById('notation').value = sel.value;
    }
    checkSaveExists();
}

function checkSaveExists() {
    const key = 'xyl_v3_' + document.getElementById('notation').value;
    const saved = localStorage.getItem(key);
    const replayBtn = document.getElementById('replayBtn');
    if (saved) {
        replayBtn.style.display = "inline-block";
        document.getElementById('saveState').innerText = "å·²å„²å­˜";
        document.getElementById('saveState').style.color = "#10b981";
    } else {
        replayBtn.style.display = "none";
        document.getElementById('saveState').innerText = "æœªå„²å­˜";
        document.getElementById('saveState').style.color = "#f87171";
    }
}

function initAudioAndStart(isReplay) {
    // 1. å¼·åˆ¶æ¿€æ´»éŸ³è¨Š
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    
    // 2. å¾¹åº•é‡ç½®ç‹€æ…‹
    ball = null;
    isStarted = false;
    isReplayMode = isReplay;
    attempts = 1;
    
    // 3. å»ºç«‹æˆ–è®€å–è·¯å¾‘
    buildTrack(isReplay);
    
    // 4. å•Ÿå‹•çƒèˆ‡ç‰©ç†
    setTimeout(() => {
        resetAndAutoStart();
    }, 50); // å¾®å°å»¶é²ç¢ºä¿ buildTrack å®Œæˆ
}

function buildTrack(isReplay) {
    const key = 'xyl_v3_' + document.getElementById('notation').value;
    const saved = localStorage.getItem(key);
    
    if (isReplay && saved) {
        const data = JSON.parse(saved);
        steps = data.map((d, i) => ({
            ...d,
            freq: freqMap[d.label] || 0,
            isStartPlate: i === 0,
            color: i === 0 ? "#64748b" : `hsl(${(i * 40) % 360}, 60%, 50%)`,
            active: 0, h: 25, hitCount: 0
        }));
        document.getElementById('modeState').innerText = "å®Œç¾é‡æ’­";
        addLog("è¼‰å…¥å®Œç¾é…ç½®...");
    } else {
        steps = [];
        steps.push({ x: 100, y: 200, w: 150, h: 20, isStartPlate: true, label: "START", color: "#64748b", active: 0, hitCount: 0 });
        
        let curX = 550, curY = 300;
        const str = document.getElementById('notation').value;
        const notes = str.match(/\+?\d| /g) || [];
        notes.forEach((n) => {
            if (n === ' ') { curX += 150; curY += 80; }
            else if (freqMap[n]) {
                steps.push({ x: curX, y: curY, freq: freqMap[n], label: n, w: 120, h: 25, active: 0, hitCount: 0, color: `hsl(${(steps.length * 40) % 360}, 60%, 50%)` });
                curX += 160; curY += 40;
            }
        });
        document.getElementById('modeState').innerText = "AI è¨“ç·´ä¸­";
        addLog("é–‹å§‹æ–°è¨“ç·´...");
    }
}

function resetAndAutoStart() {
    if (steps.length === 0) return;
    const startPlate = steps[0];
    ball = { x: startPlate.x + startPlate.w / 2, y: startPlate.y - 16, vx: 0, vy: 0, r: 12, onPlate: true };
    currentIdx = 0;
    startPlateRotation = 0;
    isStarted = true;
    steps.forEach(s => s.hitCount = 0);
    document.getElementById('att').innerText = attempts;
}

function clearCurrentMemory() {
    const key = 'xyl_v3_' + document.getElementById('notation').value;
    localStorage.removeItem(key);
    addLog("ğŸ—‘ï¸ è¨˜æ†¶å·²æ¸…é™¤");
    checkSaveExists();
}

function update() {
    if (!ball || !isStarted) return;

    if (ball.onPlate) {
        startPlateRotation += 0.013; 
        ball.vx += Math.sin(startPlateRotation) * 0.45;
        ball.x += ball.vx;
        ball.y = steps[0].y - ball.r + (ball.x - (steps[0].x + steps[0].w/2)) * Math.tan(startPlateRotation);
        if (ball.x > steps[0].x + steps[0].w) { ball.onPlate = false; currentIdx = 1; }
    } else {
        ball.vy += 0.48; ball.x += ball.vx; ball.y += ball.vy;
    }

    if (steps[currentIdx] && !ball.onPlate) {
        const target = steps[currentIdx];
        if (!isReplayMode && ball.y > target.y - 120 && ball.vy > 0) {
            target.x += (ball.x - target.w / 2 - target.x) * 0.25; 
        }
        if (ball.y > target.y + 300) {
            if(isReplayMode) { ball = null; isStarted = false; addLog("æ¼”å¥çµæŸ"); return; }
            attempts++; resetAndAutoStart();
        }
    }

    steps.forEach((s, i) => {
        if (i === 0) return; 
        if (ball && ball.x + ball.r > s.x && ball.x - ball.r < s.x + s.w &&
            ball.y + ball.r > s.y && ball.y - ball.r < s.y + s.h && ball.vy > 0) {
            
            s.hitCount++;
            if (!isReplayMode && i === currentIdx && s.hitCount >= 2) {
                s.w -= 20; s.x -= 5;
                attempts++; resetAndAutoStart(); return;
            }

            if (i === currentIdx) {
                ball.y = s.y - ball.r; ball.vy = -4.8; s.active = 15;
                
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.type = 'sine'; o.frequency.setValueAtTime(s.freq, audioCtx.currentTime);
                g.gain.setValueAtTime(0, audioCtx.currentTime);
                g.gain.linearRampToValueAtTime(0.4, audioCtx.currentTime + 0.01);
                g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                o.connect(g); g.connect(audioCtx.destination);
                o.start(); o.stop(audioCtx.currentTime + 0.5);
                
                currentIdx++;
            }
        }
    });

    if (currentIdx >= steps.length && steps.length > 1) {
        if (!isReplayMode) {
            const key = 'xyl_v3_' + document.getElementById('notation').value;
            localStorage.setItem(key, JSON.stringify(steps.map(s => ({x:s.x, y:s.y, w:s.w, label:s.label}))));
            checkSaveExists();
            addLog("ğŸ æˆåŠŸä¸¦å„²å­˜ï¼");
        }
        ball = null; isStarted = false;
    }

    camera.x += (ball.x - canvas.width/3 - camera.x) * 0.1;
    camera.y += (ball.y - canvas.height/2 - camera.y) * 0.1;
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(-camera.x, -camera.y);

    steps.forEach((s, i) => {
        ctx.save();
        if (i === 0) {
            ctx.translate(s.x + s.w/2, s.y);
            ctx.rotate(startPlateRotation);
            ctx.fillStyle = s.color;
            ctx.fillRect(-s.w/2, 0, s.w, s.h);
        } else {
            ctx.fillStyle = s.active > 0 ? '#fff' : s.color;
            if (s.active > 0) s.active--;
            ctx.beginPath(); ctx.roundRect(s.x, s.y, s.w, s.h, 6); ctx.fill();
            ctx.fillStyle = "#fff"; ctx.font = "bold 13px sans-serif";
            ctx.fillText(s.label, s.x+8, s.y+18);
        }
        ctx.restore();
    });

    if (ball) {
        ctx.fillStyle = "#ef4444";
        ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); ctx.fill();
    }
    ctx.restore();
    update();
    requestAnimationFrame(draw);
}

checkSaveExists();
draw();
</script>
</body>
</html>
