<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AI æœ¨ç´æ©Ÿ - é¦–éŸ³è‡ªå‹•æ ¡æº–ç‰ˆ</title>
    <style>
        body { margin: 0; background: #0a0a0c; color: #fff; font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        .panel { position: fixed; top: 0; width: 100%; background: rgba(20,20,25,0.9); padding: 15px; display: flex; gap: 10px; justify-content: center; z-index: 10; border-bottom: 2px solid #3b82f6; }
        canvas { background: radial-gradient(circle, #1e293b 0%, #020617 100%); border-radius: 8px; }
        .stats-overlay { position: fixed; top: 80px; right: 20px; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 10px; border: 1px solid #444; font-family: monospace; }
        .ai-log { position: fixed; bottom: 20px; left: 20px; width: 320px; max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 5px; color: #fbbf24; font-size: 12px; border-left: 4px solid #f59e0b; }
        b { color: #10b981; }
    </style>
</head>
<body>

<div class="panel">
    <strong>ç°¡è­œè¨“ç·´ï¼š</strong>
    <input type="text" id="notation" value="1231 1231 345  345" size="30" style="padding:8px; border-radius:4px; background:#222; color:#fff; border:1px solid #555;">
    <button onclick="startTraining()" style="background:#3b82f6; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-weight:bold;">é–‹å§‹è¨“ç·´æ¼”å¥</button>
</div>

<div class="stats-overlay">
    <div>å˜—è©¦æ¬¡æ•¸: <span id="att">1</span></div>
    <div>ç™¼å°„ä½ç½® X: <span id="ballX">50</span></div>
    <div>ç›®å‰é€²åº¦: <span id="prog">0</span> / <span id="total">0</span></div>
</div>

<div class="ai-log" id="log">ç³»çµ±ï¼šç­‰å¾…å•Ÿå‹•...</div>
<canvas id="mainCanvas"></canvas>

<script>
const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d');
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const freqMap = { '1': 261.6, '2': 293.7, '3': 329.6, '4': 349.2, '5': 392.0, '6': 440.0, '7': 493.9, '+1': 523.3 };

let steps = [];
let ball = null;
let camera = { x: 0, y: 0 };
let currentIdx = 0;
let attempts = 1;
let ballStartX = 50; // é€™æ˜¯æˆ‘å€‘æœƒå‹•æ…‹ä¿®æ­£çš„é—œéµåƒæ•¸
const GRAVITY = 0.45;
const VX = 5;

function addLog(msg) {
    const l = document.getElementById('log');
    l.innerHTML = `<div>[è©¦éŒ¯ ${attempts}] ${msg}</div>` + l.innerHTML;
}

function build(str) {
    steps = [];
    let curX = 220, curY = 250;
    let notes = [];
    for(let i=0; i<str.length; i++) {
        if(str[i]==='+') { notes.push('+'+str[i+1]); i++; }
        else { notes.push(str[i]); }
    }
    notes.forEach(n => {
        if (n === ' ') { curX += 160; curY += 80; }
        else if (freqMap[n]) {
            steps.push({ x: curX, y: curY, freq: freqMap[n], label: n, w: 120, h: 25, active: 0, color: `hsl(${(steps.length * 50) % 360}, 65%, 55%)` });
            curX += 160; curY += 45;
        }
    });
    document.getElementById('total').innerText = steps.length;
}

function play(f) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'triangle'; o.frequency.value = f;
    g.gain.setValueAtTime(0.3, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + 0.4);
}

function reset() {
    ball = { x: ballStartX, y: 120, vx: VX, vy: 0, r: 15 };
    currentIdx = 0;
    camera = { x: 0, y: 0 };
    document.getElementById('ballX').innerText = Math.round(ballStartX);
}

function fail(reason) {
    addLog(`<span style="color:#f87171">å¤±æ•—ï¼š${reason}</span>`);
    
    // è‡ªæˆ‘ä¿®æ­£æ ¸å¿ƒ
    if (currentIdx === 0) {
        // ç¬¬ä¸€å€‹éŸ³æ²’æ¥åˆ°ï¼Œçƒçš„ç™¼å°„ä½ç½®å‘å³ç§»å‹•
        ballStartX += 30; 
        addLog(`ğŸ”§ <b>ä¿®æ­£ï¼šçƒç™¼å°„é»å³ç§»è‡³ ${Math.round(ballStartX)}px</b>`);
    } else {
        // å¾ŒçºŒéŸ³ç¬¦æ²’æ¥åˆ°ï¼Œä¿®æ­£æ¿å­åº§æ¨™
        const t = steps[currentIdx];
        if(t) { t.x -= 30; t.y -= 30; addLog(`ğŸ”§ ä¿®æ­£éŸ³ç¬¦ [${t.label}] åº§æ¨™`); }
    }

    attempts++;
    document.getElementById('att').innerText = attempts;
    setTimeout(reset, 300);
}

function update() {
    if (!ball) return;
    ball.vy += GRAVITY;
    ball.x += ball.vx;
    ball.y += ball.vy;

    steps.forEach((s, i) => {
        if (ball.x + ball.r > s.x && ball.x - ball.r < s.x + s.w &&
            ball.y + ball.r > s.y && ball.y - ball.r < s.y + s.h && ball.vy > 0) {
            
            if (i === currentIdx) {
                ball.y = s.y - ball.r;
                ball.vy = -5;
                s.active = 15;
                play(s.freq);
                currentIdx++;
                document.getElementById('prog').innerText = currentIdx;
            } else if (i < currentIdx) {
                fail("å¡åœ¨èˆŠéŸ³éš");
            }
        }
    });

    if (steps[currentIdx]) {
        const target = steps[currentIdx];
        if (ball.x > target.x + target.w + 50 || ball.y > target.y + 300) fail("æ²’æ¥åˆ°éŸ³ç¬¦");
    } else if (currentIdx >= steps.length && steps.length > 0) {
        addLog("<b>âœ… è¨“ç·´å®Œæˆï¼</b>");
        ball = null;
    }

    camera.x += (ball.x - canvas.width/3 - camera.x) * 0.1;
    camera.y += (ball.y - canvas.height/2 - camera.y) * 0.1;
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(-camera.x, -camera.y);
    steps.forEach((s, i) => {
        ctx.fillStyle = s.active > 0 ? '#fff' : s.color;
        if (s.active > 0) s.active--;
        if (i === currentIdx) { // ç›®æ¨™æç¤º
            ctx.shadowBlur = 20; ctx.shadowColor = "#fbbf24";
            ctx.strokeStyle = "#fbbf24"; ctx.lineWidth = 2;
            ctx.strokeRect(s.x-4, s.y-4, s.w+8, s.h+8);
        }
        ctx.beginPath(); ctx.roundRect(s.x, s.y, s.w, s.h, 5); ctx.fill();
        ctx.shadowBlur = 0;
        ctx.fillStyle = "#fff"; ctx.font = "bold 14px monospace";
        ctx.fillText(s.label, s.x+10, s.y+18);
    });
    if (ball) {
        ctx.fillStyle = "#ff4757";
        ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); ctx.fill();
    }
    ctx.restore();
    update();
    requestAnimationFrame(draw);
}

function startTraining() {
    attempts = 1;
    ballStartX = 50; 
    build(document.getElementById('notation').value);
    reset();
}

startTraining();
draw();
</script>
</body>
</html>
